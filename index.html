<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Gestão">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/1e40af/ffffff?text=Gestão">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .card {
            background-color: #1f2937;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .tab-button { transition: background-color 0.3s, color 0.3s; }
        #edit-modal { transition: opacity 0.3s ease-in-out; }
        .chart-container { position: relative; height: 350px; width: 100%; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white">Sistema de Gestão</h1>
            <p class="text-gray-400 mt-2">Navegue entre Vendas, Estoque, Clientes e Relatórios.</p>
        </header>

        <!-- Navegação por Abas -->
        <div class="flex justify-center mb-8">
            <div class="bg-gray-800 rounded-lg p-1 flex space-x-1 flex-wrap justify-center">
                <button id="sales-tab" class="tab-button font-semibold py-2 px-6 rounded-md">Vendas</button>
                <button id="inventory-tab" class="tab-button font-semibold py-2 px-6 rounded-md">Estoque</button>
                <button id="customers-tab" class="tab-button font-semibold py-2 px-6 rounded-md">Clientes</button>
                <button id="reports-tab" class="tab-button font-semibold py-2 px-6 rounded-md">Relatórios</button>
            </div>
        </div>

        <!-- Conteúdo das Abas -->
        <main>
            <!-- Aba de Vendas -->
            <div id="sales-view">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card flex flex-col space-y-6">
                        <h2 class="text-2xl font-semibold text-white border-b border-gray-700 pb-3">Registar Nova Venda</h2>
                        <div class="space-y-4">
                            <div><label for="sale-product-select" class="block text-sm font-medium text-gray-300 mb-1">Selecionar Produto</label><select id="sale-product-select" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500"></select></div>
                            <div><label for="sale-quantity" class="block text-sm font-medium text-gray-300 mb-1">Quantidade</label><input type="number" id="sale-quantity" value="1" min="1" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500"></div>
                            <button id="add-to-cart-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 px-4 rounded-lg transition-colors duration-300">Adicionar ao Carrinho</button>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold">Itens da Venda Atual</h3>
                            <div id="current-sale-items" class="mt-3 space-y-2"></div>
                            <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-700"><span class="text-lg font-bold">Total:</span><span id="sale-total" class="text-2xl font-bold text-green-400">R$ 0,00</span></div>
                            <div class="mt-4 space-y-4">
                                <div><label for="sale-customer-select" class="block text-sm font-medium text-gray-300 mb-1">Selecionar Cliente (Opcional)</label><select id="sale-customer-select" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500"></select></div>
                                <div><label for="sale-payment-method" class="block text-sm font-medium text-gray-300 mb-1">Forma de Pagamento</label><select id="sale-payment-method" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500"><option>Dinheiro</option><option>PIX</option><option>Cartão de Crédito</option><option>Cartão de Débito</option></select></div>
                            </div>
                            <button id="register-sale-btn" class="w-full mt-4 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2.5 px-4 rounded-lg transition-colors duration-300 disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>Finalizar Venda</button>
                        </div>
                    </div>
                    <div class="card"><h2 class="text-2xl font-semibold text-white border-b border-gray-700 pb-3 mb-6">Histórico de Vendas</h2><div id="sales-history" class="space-y-3 max-h-[600px] overflow-y-auto pr-2"></div></div>
                </div>
            </div>

            <!-- Aba de Estoque -->
            <div id="inventory-view" class="hidden">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="card">
                         <h2 class="text-2xl font-semibold text-white border-b border-gray-700 pb-3 mb-6">Adicionar/Gerir Produto</h2>
                        <form id="product-form" class="space-y-4">
                            <div><label for="product-name" class="block text-sm font-medium text-gray-300 mb-1">Nome do Produto</label><input type="text" id="product-name" placeholder="Ex: Camiseta Branca" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500" required></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label for="product-price" class="block text-sm font-medium text-gray-300 mb-1">Preço (R$)</label><input type="number" id="product-price" placeholder="29.90" step="0.01" min="0" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500" required></div>
                                <div><label for="product-stock" class="block text-sm font-medium text-gray-300 mb-1">Estoque Inicial</label><input type="number" id="product-stock" placeholder="50" min="0" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500" required></div>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-4 rounded-lg transition-colors duration-300">Adicionar Produto</button>
                        </form>
                    </div>
                    <div class="card"><h2 class="text-2xl font-semibold text-white border-b border-gray-700 pb-3 mb-6">Estoque Atual</h2><div id="product-list" class="space-y-3 max-h-[600px] overflow-y-auto pr-2"></div></div>
                </div>
            </div>

            <!-- Aba de Clientes -->
            <div id="customers-view" class="hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="card">
                         <h2 class="text-2xl font-semibold text-white border-b border-gray-700 pb-3 mb-6">Adicionar Novo Cliente</h2>
                         <form id="customer-form" class="space-y-4">
                            <div><label for="customer-name" class="block text-sm font-medium text-gray-300 mb-1">Nome Completo</label><input type="text" id="customer-name" placeholder="Ex: João da Silva" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500" required></div>
                             <div><label for="customer-phone" class="block text-sm font-medium text-gray-300 mb-1">Telefone</label><input type="tel" id="customer-phone" placeholder="(11) 98765-4321" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500"></div>
                             <div><label for="customer-email" class="block text-sm font-medium text-gray-300 mb-1">E-mail</label><input type="email" id="customer-email" placeholder="joao.silva@email.com" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500"></div>
                             <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-4 rounded-lg transition-colors duration-300">Guardar Cliente</button>
                         </form>
                    </div>
                    <div class="card"><h2 class="text-2xl font-semibold text-white border-b border-gray-700 pb-3 mb-6">Clientes Registados</h2><div id="customer-list" class="space-y-3 max-h-[600px] overflow-y-auto pr-2"></div></div>
                </div>
            </div>
            
            <!-- Aba de Relatórios -->
            <div id="reports-view" class="hidden">
                <div class="space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 text-center">
                        <div class="card"><h3 class="text-lg text-gray-400">Receita Total</h3><p id="total-revenue" class="text-3xl font-bold text-green-400">R$ 0,00</p></div>
                        <div class="card"><h3 class="text-lg text-gray-400">Vendas Realizadas</h3><p id="total-sales" class="text-3xl font-bold text-blue-400">0</p></div>
                        <div class="card"><h3 class="text-lg text-gray-400">Ticket Médio</h3><p id="average-ticket" class="text-3xl font-bold text-yellow-400">R$ 0,00</p></div>
                        <div class="card"><h3 class="text-lg text-gray-400">Total de Produtos</h3><p id="total-products-stock" class="text-3xl font-bold text-purple-400">0</p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="card"><h3 class="text-xl font-semibold mb-4">Vendas por Dia</h3><div class="chart-container"><canvas id="salesOverTimeChart"></canvas></div></div>
                        <div class="card"><h3 class="text-xl font-semibold mb-4">Vendas por Pagamento</h3><div class="chart-container"><canvas id="paymentMethodsChart"></canvas></div></div>
                    </div>
                    <div class="grid grid-cols-1 gap-8">
                        <div class="card"><h3 class="text-xl font-semibold mb-4">Produtos Mais Vendidos (Quantidade)</h3><div class="chart-container"><canvas id="topProductsChart"></canvas></div></div>
                    </div>
                </div>
            </div>
        </main>
        
        <div id="notification" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-[-20px] transition-all duration-300"></div>

        <div id="edit-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 opacity-0 z-50">
            <div class="card w-full max-w-md">
                <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-semibold text-white">Editar Produto</h2><button id="close-modal-btn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button></div>
                <form id="edit-product-form" class="space-y-4">
                    <input type="hidden" id="edit-product-id">
                    <div><label for="edit-product-name" class="block text-sm font-medium text-gray-300 mb-1">Nome do Produto</label><input type="text" id="edit-product-name" class="w-full bg-gray-600 border border-gray-500 text-gray-300 rounded-lg p-2.5 cursor-not-allowed" readonly></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label for="edit-product-price" class="block text-sm font-medium text-gray-300 mb-1">Preço (R$)</label><input type="number" id="edit-product-price" step="0.01" min="0" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500" required></div>
                        <div><label for="edit-product-stock" class="block text-sm font-medium text-gray-300 mb-1">Quantidade em Estoque</label><input type="number" id="edit-product-stock" min="0" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500" required></div>
                    </div>
                    <div class="flex space-x-4 mt-6">
                        <button type="button" id="cancel-edit-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2.5 px-4 rounded-lg transition-colors">Cancelar</button>
                        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2.5 px-4 rounded-lg transition-colors">Guardar Alterações</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('/service-worker.js').then(reg => console.log('Service Worker: Registado')).catch(err => console.log(`Service Worker: Erro: ${err}`)); }); }

        document.addEventListener('DOMContentLoaded', () => {
            const salesTab = document.getElementById('sales-tab'), inventoryTab = document.getElementById('inventory-tab'), customersTab = document.getElementById('customers-tab'), reportsTab = document.getElementById('reports-tab');
            const salesView = document.getElementById('sales-view'), inventoryView = document.getElementById('inventory-view'), customersView = document.getElementById('customers-view'), reportsView = document.getElementById('reports-view');
            const productForm = document.getElementById('product-form'), productNameInput = document.getElementById('product-name'), productPriceInput = document.getElementById('product-price'), productStockInput = document.getElementById('product-stock'), productList = document.getElementById('product-list');
            const saleProductSelect = document.getElementById('sale-product-select'), saleCustomerSelect = document.getElementById('sale-customer-select'), saleQuantityInput = document.getElementById('sale-quantity'), addToCartBtn = document.getElementById('add-to-cart-btn'), currentSaleItems = document.getElementById('current-sale-items'), saleTotal = document.getElementById('sale-total'), registerSaleBtn = document.getElementById('register-sale-btn'), salesHistory = document.getElementById('sales-history'), salePaymentMethodSelect = document.getElementById('sale-payment-method');
            const customerForm = document.getElementById('customer-form'), customerNameInput = document.getElementById('customer-name'), customerPhoneInput = document.getElementById('customer-phone'), customerEmailInput = document.getElementById('customer-email'), customerList = document.getElementById('customer-list');
            const notification = document.getElementById('notification');
            const editModal = document.getElementById('edit-modal'), editProductForm = document.getElementById('edit-product-form'), editProductIdInput = document.getElementById('edit-product-id'), editProductNameInput = document.getElementById('edit-product-name'), editProductPriceInput = document.getElementById('edit-product-price'), editProductStockInput = document.getElementById('edit-product-stock'), closeModalBtn = document.getElementById('close-modal-btn'), cancelEditBtn = document.getElementById('cancel-edit-btn');
            const totalRevenueEl = document.getElementById('total-revenue'), totalSalesEl = document.getElementById('total-sales'), averageTicketEl = document.getElementById('average-ticket'), totalProductsStockEl = document.getElementById('total-products-stock');

            let products = JSON.parse(localStorage.getItem('products')) || [], sales = JSON.parse(localStorage.getItem('sales')) || [], customers = JSON.parse(localStorage.getItem('customers')) || [], currentCart = [], chartInstances = {};

            const showNotification = (message, isError = false) => { notification.textContent = message; notification.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-all duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'} opacity-100 translate-y-0`; setTimeout(() => notification.className = notification.className.replace('opacity-100 translate-y-0', 'opacity-0 translate-y-[-20px]'), 3000); };
            const renderProducts = () => { productList.innerHTML = products.length ? products.map(p => `<div class="flex justify-between items-center bg-gray-700 p-3 rounded-lg"><div><p class="font-semibold text-white">${p.name}</p><p class="text-sm text-gray-400">Preço: R$ ${p.price.toFixed(2)} | Estoque: ${p.stock}</p></div><div class="flex items-center space-x-2"><button data-id="${p.id}" class="edit-product-btn text-blue-400 hover:text-blue-600 transition-colors p-1 rounded-full" title="Editar Produto"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg></button><button data-id="${p.id}" class="delete-product-btn text-red-400 hover:text-red-600 transition-colors p-1 rounded-full" title="Remover Produto"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button></div></div>`).join('') : '<p class="text-gray-500">Nenhum produto registado.</p>'; };
            const renderCustomers = () => { customerList.innerHTML = customers.length ? customers.map(c => `<div class="flex justify-between items-start bg-gray-700 p-3 rounded-lg"><div><p class="font-semibold text-white">${c.name}</p>${c.phone ? `<p class="text-sm text-gray-400">Tel: ${c.phone}</p>` : ''}${c.email ? `<p class="text-sm text-gray-400">Email: ${c.email}</p>` : ''}</div><button data-id="${c.id}" class="delete-customer-btn text-red-400 hover:text-red-600 transition-colors p-1 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button></div>`).join('') : '<p class="text-gray-500">Nenhum cliente registado.</p>'; };
            const updateProductSelect = () => { const a = products.filter(p => p.stock > 0); saleProductSelect.innerHTML = a.length ? a.map(p => `<option value="${p.id}">${p.name} (Estoque: ${p.stock})</option>`).join('') : `<option>${products.length ? "Todos os produtos sem estoque" : "Registe um produto no estoque"}</option>`; };
            const updateCustomerSelect = () => { saleCustomerSelect.innerHTML = '<option value="0">Cliente Avulso</option>' + customers.map(c => `<option value="${c.id}">${c.name}</option>`).join(''); };
            const renderCart = () => { let t = currentCart.reduce((s, i) => s + i.quantity * i.price, 0); currentSaleItems.innerHTML = currentCart.length ? currentCart.map(i => `<div class="flex justify-between items-center bg-gray-700/50 p-2 rounded-md"><span>${i.quantity}x ${i.name}</span><span>R$ ${(i.quantity * i.price).toFixed(2)}</span></div>`).join('') : '<p class="text-gray-500">O carrinho está vazio.</p>'; saleTotal.textContent = `R$ ${t.toFixed(2)}`; registerSaleBtn.disabled = !currentCart.length; };
            const renderSalesHistory = () => { salesHistory.innerHTML = sales.length ? [...sales].sort((a, b) => new Date(b.date) - new Date(a.date)).map(s => { const d = new Date(s.date); return `<div class="bg-gray-700 p-3 rounded-lg"><div class="flex justify-between items-start"><div><p class="font-bold">Venda #${s.id.toString().slice(-4)}</p><p class="text-sm text-gray-400">${d.toLocaleDateString()} ${d.toLocaleTimeString()}</p><p class="text-sm text-gray-300 font-medium mt-1">Cliente: ${s.customerName || 'Cliente Avulso'}</p><p class="text-sm text-gray-400">Pagamento: ${s.paymentMethod || 'Não especificado'}</p></div><p class="font-bold text-lg text-green-400">R$ ${s.total.toFixed(2)}</p></div><ul class="text-sm text-gray-300 list-disc list-inside mt-2">${s.items.map(i => `<li>${i.quantity}x ${i.name}</li>`).join('')}</ul></div>`; }).join('') : '<p class="text-gray-500">Nenhuma venda registada.</p>'; };
            const renderChart = (canvasId, type, data, options = {}) => { const ctx = document.getElementById(canvasId).getContext('2d'); if (chartInstances[canvasId]) { chartInstances[canvasId].destroy(); } const finalOptions = { ...options, responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#d1d5db' } } } }; if (type !== 'pie' && type !== 'doughnut') { finalOptions.scales = { y: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } }, x: { ticks: { color: '#9ca3af' }, grid: { color: '#374151' } } }; } chartInstances[canvasId] = new Chart(ctx, { type, data, options: finalOptions }); };
            const renderReports = () => {
                if (typeof Chart === 'undefined') {
                    console.error("A biblioteca Chart.js não foi carregada.");
                    reportsView.innerHTML = `<div class="card text-center"><h3 class="text-xl font-semibold text-red-400">Não foi possível carregar os gráficos.</h3><p class="text-gray-400 mt-2">Verifique a sua ligação à internet e atualize a página.</p></div>`;
                    return;
                }
                try {
                    const originalLayout = `<div class="space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 text-center">
                        <div class="card"><h3 class="text-lg text-gray-400">Receita Total</h3><p id="total-revenue" class="text-3xl font-bold text-green-400">R$ 0,00</p></div>
                        <div class="card"><h3 class="text-lg text-gray-400">Vendas Realizadas</h3><p id="total-sales" class="text-3xl font-bold text-blue-400">0</p></div>
                        <div class="card"><h3 class="text-lg text-gray-400">Ticket Médio</h3><p id="average-ticket" class="text-3xl font-bold text-yellow-400">R$ 0,00</p></div>
                        <div class="card"><h3 class="text-lg text-gray-400">Total de Produtos</h3><p id="total-products-stock" class="text-3xl font-bold text-purple-400">0</p></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="card"><h3 class="text-xl font-semibold mb-4">Vendas por Dia</h3><div class="chart-container"><canvas id="salesOverTimeChart"></canvas></div></div>
                        <div class="card"><h3 class="text-xl font-semibold mb-4">Vendas por Pagamento</h3><div class="chart-container"><canvas id="paymentMethodsChart"></canvas></div></div>
                    </div>
                    <div class="grid grid-cols-1 gap-8">
                        <div class="card"><h3 class="text-xl font-semibold mb-4">Produtos Mais Vendidos (Quantidade)</h3><div class="chart-container"><canvas id="topProductsChart"></canvas></div></div>
                    </div>
                </div>`;
                if (!reportsView.querySelector('#total-revenue')) {
                    reportsView.innerHTML = originalLayout;
                }
                document.getElementById('total-revenue').textContent = `R$ ${sales.reduce((s, sa) => s + sa.total, 0).toFixed(2)}`;
                document.getElementById('total-sales').textContent = sales.length;
                document.getElementById('average-ticket').textContent = `R$ ${(sales.length > 0 ? sales.reduce((s, sa) => s + sa.total, 0) / sales.length : 0).toFixed(2)}`;
                document.getElementById('total-products-stock').textContent = products.reduce((s, p) => s + p.stock, 0);

                const salesByDay = sales.reduce((acc, sale) => { const date = new Date(sale.date).toLocaleDateString('pt-BR'); acc[date] = (acc[date] || 0) + sale.total; return acc; }, {}); 
                const topProducts = sales.flatMap(sale => sale.items).reduce((acc, item) => { acc[item.name] = (acc[item.name] || 0) + item.quantity; return acc; }, {}); 
                const sortedTopProducts = Object.entries(topProducts).sort(([, a], [, b]) => b - a).slice(0, 5); 
                const salesByPayment = sales.reduce((acc, s) => { const method = s.paymentMethod || 'Não definido'; acc[method] = (acc[method] || 0) + s.total; return acc; }, {}); 

                renderChart('salesOverTimeChart', 'bar', { labels: Object.keys(salesByDay), datasets: [{ label: 'Receita Diária (R$)', data: Object.values(salesByDay), backgroundColor: 'rgba(59, 130, 246, 0.7)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1 }] }); 
                renderChart('topProductsChart', 'bar', { labels: sortedTopProducts.map(p => p[0]), datasets: [{ label: 'Quantidade Vendida', data: sortedTopProducts.map(p => p[1]), backgroundColor: ['#10b981', '#3b82f6', '#f97316', '#8b5cf6', '#ec4899'], hoverOffset: 4 }] }, { indexAxis: 'y' }); 
                renderChart('paymentMethodsChart', 'pie', { labels: Object.keys(salesByPayment), datasets: [{ label: 'Receita por Pagamento', data: Object.values(salesByPayment), backgroundColor: ['#3b82f6', '#ef4444', '#f97316', '#8b5cf6', '#10b981'], hoverOffset: 4 }] }); 
            } catch (e) { console.error("Erro ao renderizar relatórios:", e); reportsView.innerHTML = '<div class="card text-center"><h3 class="text-xl font-semibold text-red-400">Ocorreu um erro ao gerar os relatórios.</h3><p class="text-gray-400 mt-2">Verifique a consola para mais detalhes.</p></div>'; }
        };

            const saveData = () => { localStorage.setItem('products', JSON.stringify(products)); localStorage.setItem('sales', JSON.stringify(sales)); localStorage.setItem('customers', JSON.stringify(customers)); };
            const renderAll = () => { renderProducts(); renderCustomers(); updateProductSelect(); updateCustomerSelect(); renderCart(); renderSalesHistory(); };
            
            const openEditModal = id => { const p = products.find(p => p.id === id); if(p){ editProductIdInput.value = p.id; editProductNameInput.value = p.name; editProductPriceInput.value = p.price.toFixed(2); editProductStockInput.value = p.stock; editModal.classList.remove('hidden'); setTimeout(() => editModal.classList.remove('opacity-0'), 10); } };
            const closeEditModal = () => { editModal.classList.add('opacity-0'); setTimeout(() => editModal.classList.add('hidden'), 300); };
            
            productForm.addEventListener('submit', e => { e.preventDefault(); products.push({ id: Date.now(), name: productNameInput.value.trim(), price: parseFloat(productPriceInput.value), stock: parseInt(productStockInput.value) }); saveData(); renderAll(); productForm.reset(); showNotification('Produto adicionado ao estoque!'); });
            customerForm.addEventListener('submit', e => { e.preventDefault(); customers.push({ id: Date.now(), name: customerNameInput.value.trim(), phone: customerPhoneInput.value.trim(), email: customerEmailInput.value.trim() }); saveData(); renderAll(); customerForm.reset(); showNotification('Cliente guardado com sucesso!'); });
            
            document.body.addEventListener('click', e => { const editBtn = e.target.closest('.edit-product-btn'); if (editBtn) return openEditModal(parseInt(editBtn.dataset.id)); const deleteBtn = e.target.closest('.delete-product-btn'); if (deleteBtn) { if (confirm('Tem a certeza que deseja remover este produto?')) { products = products.filter(p => p.id !== parseInt(deleteBtn.dataset.id)); saveData(); renderAll(); showNotification('Produto removido.', true); } return; } const deleteCustomerBtn = e.target.closest('.delete-customer-btn'); if (deleteCustomerBtn) { customers = customers.filter(c => c.id !== parseInt(deleteCustomerBtn.dataset.id)); saveData(); renderAll(); showNotification('Cliente removido.', true); } });
            
            addToCartBtn.addEventListener('click', () => { const id = parseInt(saleProductSelect.value), qty = parseInt(saleQuantityInput.value), p = products.find(p => p.id === id); if (!p || qty <= 0 || qty > p.stock) return showNotification('Verifique o produto e a quantidade. Estoque pode ser insuficiente.', true); const item = currentCart.find(i => i.id === id); if (item) { if (item.quantity + qty > p.stock) return showNotification('Estoque insuficiente para a quantidade total no carrinho.', true); item.quantity += qty; } else { currentCart.push({ ...p, quantity: qty }); } renderCart(); saleQuantityInput.value = 1; });
            registerSaleBtn.addEventListener('click', () => { if (!currentCart.length) return; const custId = parseInt(saleCustomerSelect.value), c = customers.find(c => c.id === custId), paymentMethod = salePaymentMethodSelect.value; sales.push({ id: Date.now(), date: new Date().toISOString(), items: currentCart, total: currentCart.reduce((s, i) => s + i.quantity * i.price, 0), customerId: c ? c.id : null, customerName: c ? c.name : 'Cliente Avulso', paymentMethod: paymentMethod }); currentCart.forEach(i => { const p = products.find(p => p.id === i.id); if (p) p.stock -= i.quantity; }); currentCart = []; saveData(); renderAll(); showNotification('Venda registada com sucesso!'); });
            
            editProductForm.addEventListener('submit', e => { e.preventDefault(); const id = parseInt(editProductIdInput.value), price = parseFloat(editProductPriceInput.value), stock = parseInt(editProductStockInput.value), idx = products.findIndex(p => p.id === id); if (idx > -1) { products[idx].price = price; products[idx].stock = stock; saveData(); renderAll(); closeEditModal(); showNotification('Produto atualizado com sucesso!'); } else { showNotification('Erro: Produto não encontrado.', true); } });
            closeModalBtn.addEventListener('click', closeEditModal); cancelEditBtn.addEventListener('click', closeEditModal);

            const setActiveTab = (activeBtn, activeView) => { [salesTab, inventoryTab, customersTab, reportsTab].forEach(t => { t.classList.remove('bg-blue-600', 'text-white'); t.classList.add('text-gray-300', 'hover:bg-gray-700'); }); [salesView, inventoryView, customersView, reportsView].forEach(v => v.classList.add('hidden')); activeBtn.classList.add('bg-blue-600', 'text-white'); activeBtn.classList.remove('text-gray-300', 'hover:bg-gray-700'); activeView.classList.remove('hidden'); if (activeView.id === 'reports-view') { renderReports(); } };
            salesTab.addEventListener('click', () => setActiveTab(salesTab, salesView)); inventoryTab.addEventListener('click', () => setActiveTab(inventoryTab, inventoryView)); customersTab.addEventListener('click', () => setActiveTab(customersTab, customersView)); reportsTab.addEventListener('click', () => setActiveTab(reportsTab, reportsView));
            
            renderAll();
            setActiveTab(salesTab, salesView); 
        });
    </script>
</body>
</html>

